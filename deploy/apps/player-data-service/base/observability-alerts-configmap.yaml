apiVersion: v1
kind: ConfigMap
metadata:
  name: player-data-service-alert-rules
  namespace: opus-major
  labels:
    app.kubernetes.io/name: player-data-service
    app.kubernetes.io/part-of: opus-major-assignment
    app.kubernetes.io/component: observability
    observability.opus-major.io/type: prometheus-rules
data:
  player-data-service.rules.yaml: |
    groups:
      - name: player-data-service.slo
        interval: 30s
        rules:
          - alert: PlayerDataServiceHigh5xxRatio
            expr: |
              (
                sum(rate(http_requests_total{path="/player-data",status=~"5.."}[5m]))
                /
                clamp_min(sum(rate(http_requests_total{path="/player-data"}[5m])), 0.001)
              ) > 0.05
            for: 10m
            labels:
              severity: warning
              service: player-data-service
              slo: availability
            annotations:
              summary: "High 5xx ratio on /player-data"
              description: "5xx ratio has been above 5% for 10 minutes."

          - alert: PlayerDataServiceHighP95Latency
            expr: |
              histogram_quantile(
                0.95,
                sum by (le) (rate(http_request_duration_seconds_bucket{path="/player-data"}[5m]))
              ) > 0.50
            for: 10m
            labels:
              severity: warning
              service: player-data-service
              slo: latency
            annotations:
              summary: "High p95 latency on /player-data"
              description: "p95 latency has been above 500ms for 10 minutes."

          - alert: PlayerDataServiceLowAvailability
            expr: |
              (
                1 -
                (
                  sum(rate(http_requests_total{path="/player-data",status=~"5.."}[5m]))
                  /
                  clamp_min(sum(rate(http_requests_total{path="/player-data"}[5m])), 0.001)
                )
              ) < 0.995
            for: 15m
            labels:
              severity: critical
              service: player-data-service
              slo: availability
            annotations:
              summary: "Low availability on /player-data"
              description: "Availability is below 99.5% for 15 minutes."
